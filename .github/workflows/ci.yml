name: CI - Code Quality & Testing

on:
  pull_request:
    branches: 
      - main
      - dev
  push:
    branches:
      - main
      - dev

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black pylint isort
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Run Black (Code Formatting Check)
        run: |
          black --check --diff .
        continue-on-error: false
      
      - name: Run isort (Import Sorting Check)
        run: |
          isort --check-only --diff .
        continue-on-error: false
      
      - name: Run Flake8 (Linting)
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      
      - name: Run Pylint (Code Analysis)
        run: |
          pylint dags/**/*.py include/**/*.py --fail-under=7.0 --disable=C0111,R0913,R0914
        continue-on-error: true

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-mock
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Run Unit Tests
        run: |
          pytest tests/ --verbose --cov=include --cov-report=xml --cov-report=term
        continue-on-error: false
      
      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety
      
      - name: Run Bandit (Security Issues)
        run: |
          bandit -r include/ dags/ -f json -o bandit-report.json
        continue-on-error: true
      
      - name: Run Safety (Dependency Vulnerabilities)
        run: |
          safety check --json
        continue-on-error: true
      
      - name: Upload Bandit Report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json

  dbt-test:
    name: dbt Validation
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dbt
        run: |
          pip install dbt-core==1.8.0 dbt-snowflake==1.8.0
      
      - name: dbt Parse
        run: |
          cd dbt
          dbt parse
        env:
          DBT_PROFILES_DIR: ./dbt
      
      - name: dbt Compile
        run: |
          cd dbt
          dbt compile
        env:
          DBT_PROFILES_DIR: ./dbt

  airflow-validation:
    name: Airflow DAG Validation
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install Airflow
        run: |
          pip install apache-airflow==3.0.6
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Validate DAGs
        run: |
          python -c "
          import sys
          from pathlib import Path
          sys.path.insert(0, str(Path.cwd()))
          
          from airflow.models import DagBag
          
          dag_bag = DagBag(dag_folder='dags/', include_examples=False)
          
          if dag_bag.import_errors:
              print('DAG Import Errors:')
              for filename, error in dag_bag.import_errors.items():
                  print(f'{filename}: {error}')
              sys.exit(1)
          
          print(f'Successfully validated {len(dag_bag.dags)} DAG(s)')
          for dag_id, dag in dag_bag.dags.items():
              print(f'  - {dag_id}: {len(dag.tasks)} tasks')
          "

  docker-build-test:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker Image (Test)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: coretelecoms-airflow:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Test Docker Image
        run: |
          docker run --rm coretelecoms-airflow:test python --version
          docker run --rm coretelecoms-airflow:test pip list

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [code-quality, test, security-scan, dbt-test, airflow-validation, docker-build-test]
    if: always()
    
    steps:
      - name: Check Results
        run: |
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "unit Tests: ${{ needs.test.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          echo "dbt Validation: ${{ needs.dbt-test.result }}"
          echo "Airflow Validation: ${{ needs.airflow-validation.result }}"
          echo "Docker Build: ${{ needs.docker-build-test.result }}"
          
          if [[ "${{ needs.code-quality.result }}" == "failure" ]] || \
             [[ "${{ needs.test.result }}" == "failure" ]] || \
             [[ "${{ needs.airflow-validation.result }}" == "failure" ]] || \
             [[ "${{ needs.docker-build-test.result }}" == "failure" ]]; then
            echo "CI Pipeline Failed"
            exit 1
          else
            echo " CI Pipeline Passed"
          fi